<!doctype html>
<html>
<head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Protocol Buffer 基础 | Protocol Buffer 基础</title>
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" media="screen">
    <link rel="stylesheet" href="/static/style.css" type="text/css">
    <link href="/feed.atom" rel="alternate" title=" Protocol Buffer 基础" type="application/atom+xml">
    
    <link rel="stylesheet" href="/static/pygments.css"  type="text/css">
    
    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?7972bc564f84e320d4f261fe1ada61da";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

</head>

<body>
<div class="container box">



<div>
        <h1>Protocol Buffer 基础</h1>

    <h2>序列化</h2>
<p>我们知道，在 TCP 的连接上，它传输数据的基本形式就是二进制流或者比特流，也就是一段一段的 1 和 0。在一般网络框架提供的 API 中，数据传输的形式是字节，也就是 Byte，一个字节就是8个二进制位，所以在这里，二进制流和字节流本质是一样的。</p>
<p>那对于我们编写的程序来说，它需要通过网络传输的数据是什么形式的呢？是<strong>结构化的数据</strong>，比如，一条命令、一条消息或者是一段文本。对应到我们写的代码中，这些结构化的数据是什么呢？我们可以用字符串 string、列表 list、或者字典 dict 来表示；在面向对象编程中，我们则更喜欢用<strong>类 Class</strong> 来表示。</p>
<p>那显然，想要使用网络框架的 API 来传输结构化的数据，必须的先实现结构化的数据与字节流之间的双向转换。这种将结构化数据转换成字节流的过程，我们称为<strong>序列化</strong>，反过来转换，就是<strong>反序列化</strong>。</p>
<p>序列化的用途除了用于在网络上传输数据以外，另外的一个重要用途是，将结构化数据保存在文件中，因为在文件内保存数据的形式也是二进制序列，和网络传输过程中的数据是一样的，所以序列化同样适用于将结构化数据保存在文件中。</p>
<p>很多处理海量数据的场景中，都需要将对象序列化后，把他们暂时从内存转移到磁盘中，等需要用的时候，再把数据从磁盘中读取出来，反序列化成对象来使用，这样不仅可以长期保存不丢失数据，而且可以节省有限的内存空间。</p>
<p>如果说，只是实现序列化和反序列化的功能，并不难，方法也有很多。比如，现在编程语言都内置了序列化实现，比如 Python 中的 pickle 模块：</p>
<div class="codehilite"><pre><span></span><code><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">pickle</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">user</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jachinlin&#39;</span><span class="p">,</span> <span class="n">sex</span><span class="o">=</span><span class="s1">&#39;男&#39;</span><span class="p">)</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x80\x03</span><span class="s1">}q</span><span class="se">\x00</span><span class="s1">(X</span><span class="se">\x04\x00\x00\x00</span><span class="s1">nameq</span><span class="se">\x01</span><span class="s1">X</span><span class="se">\t\x00\x00\x00</span><span class="s1">jachinlinq</span><span class="se">\x02</span><span class="s1">X</span><span class="se">\x03\x00\x00\x00</span><span class="s1">sexq</span><span class="se">\x03</span><span class="s1">X</span><span class="se">\x03\x00\x00\x00\xe7\x94\xb7</span><span class="s1">q</span><span class="se">\x04</span><span class="s1">u.&#39;</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span>  <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x80\x03</span><span class="s1">}q</span><span class="se">\x00</span><span class="s1">(X</span><span class="se">\x04\x00\x00\x00</span><span class="s1">nameq</span><span class="se">\x01</span><span class="s1">X</span><span class="se">\t\x00\x00\x00</span><span class="s1">jachinlinq</span><span class="se">\x02</span><span class="s1">X</span><span class="se">\x03\x00\x00\x00</span><span class="s1">sexq</span><span class="se">\x03</span><span class="s1">X</span><span class="se">\x03\x00\x00\x00\xe7\x94\xb7</span><span class="s1">q</span><span class="se">\x04</span><span class="s1">u.&#39;</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>  <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;jachinlin&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">:</span> <span class="s1">&#39;男&#39;</span><span class="p">}</span>
</code></pre></div>


<p>pickle 的问题和所有其他编程语言特有的序列化内置模块一样，就是它只能用于 Python，并且可能不同版本的 Python 彼此都不兼容。</p>
<p>对于一些强业务系统，如果对于性能的要求没有那么苛刻，更好的选择是 JSON 和 XML（JSON 优于 XML）这种序列化实现。这种实现使用起来比较简单、序列化后的数据也是我们可以看懂的格式，无论是接口调试还是排查问题都非常方便。付出的代价就是多一点点 CPU 时间和存储空间而已。</p>
<p>如果，我们对序列化的性能、信息密度（序列化后占用的存储空间）要求比较高，那 JSON、XML可能就满足不了咱们的要求。这时候就需要专业的序列化实现，比如 Google 的Protocol Buffer。</p>
<h2>Protocol Buffer</h2>
<p>Protocol Buffer ，简称 protobuf，是 Google 开发的一套<strong>语言无关</strong>、<strong>平台无关</strong>、<strong>可扩展的</strong>、<strong>轻便高效</strong>的序列化和反序列化实现。</p>
<p>语言无关和平台无关比较好理解，简单说就是跨语言、跨平台。可扩展，是指我们可以随时对结构化数据进行更新升级，应用程序不作修改也可以兼容旧的消息格式，因此也称为可兼容。轻便高效，是指 protobuf 能够更高效率地序列化和反序列结构化数据，并且序列化的数据占用空间小。</p>
<p>使用 protobuf，我们需要做三件事情：</p>
<p><strong>定义 Message 类型</strong></p>
<p>为了语言无关，protobuf 自创了一套语法，我们需要用这套语法来定义结构化数据的格式（IDL），一个结构化数的格式称作一个 Message（消息）类型，这些定义需要卸载 <code>.proto</code> 文件中。</p>
<p><strong>将 Message 类型编译成各个的 class 代码</strong></p>
<p>是用 protobuf 定义的消息类型是不为 Python、Java等语言识别的，因此，我们还需要一个软件工具，这个工具的作用就是将 protobuf 消息类型转换成 Python 等具体语言能直接只用的代码，因此这个工具也被叫做<strong>编译器</strong>，下文中出现的 <code>protoc</code>—— protobuf compiler 就是指这个编译器。</p>
<p><strong>使用编译后的 class 代码对消息进行读写</strong></p>
<p>写，即是将 class 示例序列化为字节流；读，即是将字节流反序列化成 class 示例</p>
<h2>protobuf 实战 —— 通讯录应用</h2>
<p>现在，我们通过一个小小的应用程序——通讯录——来学习 Protocol Buffer 的基础知识和使用，通过开发通讯录应用，我们将学会：</p>
<ul>
<li>使用<code>.proto</code> 文件定义消息格式</li>
<li>使用 Protocol Buffer 编译器</li>
<li>使用 Protocol Buffer API 来读写消息</li>
</ul>
<p>通讯录应用可以从一个文件读写人们的联系信息，一个人的联系信息包括一个名字、一个ID、一个电子邮箱、以及若干个电话（工作电话、家庭电话等）。</p>
<h3>准备工作</h3>
<p>首先，我们需要安装 protobuf 编译器。</p>
<p>protobuf 的 GitHub 地址上有各种语言的编译打包好的二进制文件，咱们选择相应系统版本的编译器直接下载然后解压即可，这里我以 mac OS 为例：</p>
<div class="codehilite"><pre><span></span><code>wget https://github.com/protocolbuffers/protobuf/releases/download/v3.9.1/protoc-3.9.1-osx-x86_64.zip -O protoc.zip  <span class="o">&amp;&amp;</span> unzip protoc.zip -d ~/protoc <span class="o">&amp;&amp;</span>  rm protoc.zip
</code></pre></div>


<p>接下来是，安装运行依赖库。</p>
<p>protobuf  的 Python 运行时类库已经发布到 PyPi 了，咱们直接 pip install 一下就可以了。</p>
<div class="codehilite"><pre><span></span><code>python3 -m venv .venv
<span class="nb">source</span> .venv/bin/activate
pip isntall protobuf
</code></pre></div>


<h3>定义消息格式</h3>
<div class="codehilite"><pre><span></span><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">&quot;proto3&quot;</span><span class="p">;</span>

<span class="kn">package</span> <span class="nn">tutorial</span><span class="p">;</span>


<span class="kd">message</span> <span class="nc">Person</span> <span class="p">{</span>
    <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">string</span> <span class="na">email</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

    <span class="kd">enum</span> <span class="n">PhoneType</span> <span class="p">{</span>
        <span class="na">MOBILE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="na">HOME</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="na">WORK</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">message</span> <span class="nc">PhoneNumber</span> <span class="p">{</span>
        <span class="kt">string</span> <span class="na">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">PhoneType</span> <span class="na">type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">repeated</span> <span class="n">PhoneNumber</span> <span class="na">phones</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">AddressBook</span> <span class="p">{</span>
    <span class="k">repeated</span> <span class="n">Person</span> <span class="na">people</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<h3>编译 proto 文件</h3>
<div class="codehilite"><pre><span></span><code> ~/protoc/bin/protoc -I./addressbook --python_out<span class="o">=</span>./addressbook ./addressbook/addressbook.proto
</code></pre></div>


<h3>开发通讯录应用</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">addressbook</span> <span class="kn">import</span> <span class="n">addressbook_pb2</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AddressBook</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">address_book</span> <span class="o">=</span> <span class="n">addressbook_pb2</span><span class="o">.</span><span class="n">AddressBook</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_address_book</span> <span class="o">=</span> <span class="n">address_book</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">address_book</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">: File not found. Creating a new file.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_name</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_address_book</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">prompt_add_person</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">addressbook_pb2</span><span class="o">.</span><span class="n">Person</span><span class="p">:</span>
        <span class="n">person</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address_book</span><span class="o">.</span><span class="n">people</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
        <span class="n">person</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter person ID number: &quot;</span><span class="p">))</span>
        <span class="n">person</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter name: &quot;</span><span class="p">)</span>

        <span class="n">email</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter email address (blank for none): &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">email</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">person</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">number</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;Enter a phone number (or leave blank to finish): &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">number</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="n">phone_number</span> <span class="o">=</span> <span class="n">person</span><span class="o">.</span><span class="n">phones</span><span class="o">.</span><span class="n">add</span><span class="p">()</span>
            <span class="n">phone_number</span><span class="o">.</span><span class="n">number</span> <span class="o">=</span> <span class="n">number</span>

            <span class="n">type_</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Is this a mobile, home, or work phone? &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;mobile&quot;</span><span class="p">:</span>
                <span class="n">phone_number</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">addressbook_pb2</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">MOBILE</span>
            <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;home&quot;</span><span class="p">:</span>
                <span class="n">phone_number</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">addressbook_pb2</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">HOME</span>
            <span class="k">elif</span> <span class="n">type_</span> <span class="o">==</span> <span class="s2">&quot;work&quot;</span><span class="p">:</span>
                <span class="n">phone_number</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">addressbook_pb2</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">WORK</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown phone type; leaving as default value.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">person</span>

    <span class="k">def</span> <span class="nf">list_people</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">person</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_address_book</span><span class="o">.</span><span class="n">people</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Person ID:&quot;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Name:&quot;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">person</span><span class="o">.</span><span class="n">email</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  E-mail address:&quot;</span><span class="p">,</span> <span class="n">person</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">phone_number</span> <span class="ow">in</span> <span class="n">person</span><span class="o">.</span><span class="n">phones</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">phone_number</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">addressbook_pb2</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">MOBILE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Mobile phone #:&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">phone_number</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">addressbook_pb2</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">HOME</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Home phone #:&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">phone_number</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">addressbook_pb2</span><span class="o">.</span><span class="n">Person</span><span class="o">.</span><span class="n">WORK</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  Work phone #:&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">phone_number</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
</code></pre></div>


<p>代码 <a href="https://github.com/jachinlin/python-demo/tree/master/protobuf_addressbook">addressbook</a></p>
<h2>参考</h2>
<ul>
<li>https://developers.google.com/protocol-buffers/docs/pythontutorial</li>
<li>https://developers.google.com/protocol-buffers/docs/proto3</li>
<li>https://developers.google.com/protocol-buffers/docs/reference/python/</li>
</ul>

    
        <p class=tags>标签：
        <a href="/tags/protobuf/">protobuf</a>
    

    
</div>



</div>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>
